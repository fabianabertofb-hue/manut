<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Manuten√ß√£oCRM</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=DM+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  :root {
    --bg: #0A0F1E;
    --surface: #111827;
    --surface2: #1a2235;
    --border: #1f2d45;
    --border2: #2a3d5a;
    --text: #E8EDF5;
    --muted: #5a7090;
    --subtle: #8099b8;
    --accent: #00D4FF;
    --accent2: #0099cc;
    --amber: #F5A623; --amber-bg: rgba(245,166,35,0.12);
    --blue: #3B8BF6; --blue-bg: rgba(59,139,246,0.12);
    --purple: #9B6CF6; --purple-bg: rgba(155,108,246,0.12);
    --orange: #F97316; --orange-bg: rgba(249,115,22,0.12);
    --green: #00C896; --green-bg: rgba(0,200,150,0.12);
    --red: #FF4D6D;
    --grid-color: rgba(0,212,255,0.03);
  }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    min-height: 100vh;
    background-image:
      linear-gradient(var(--grid-color) 1px, transparent 1px),
      linear-gradient(90deg, var(--grid-color) 1px, transparent 1px);
    background-size: 40px 40px;
  }

  /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
  header {
    border-bottom: 1px solid var(--border);
    padding: 0 32px;
    background: rgba(10,15,30,0.9);
    backdrop-filter: blur(12px);
    position: sticky;
    top: 0;
    z-index: 50;
  }
  .header-inner { max-width: 1300px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; height: 64px; }
  .logo { display: flex; align-items: center; gap: 12px; }
  .logo-icon {
    width: 38px; height: 38px; border-radius: 10px;
    background: var(--accent);
    display: flex; align-items: center; justify-content: center;
    font-size: 18px;
    box-shadow: 0 0 20px rgba(0,212,255,0.4);
  }
  .logo-name {
    font-family: 'Space Mono', monospace;
    font-size: 16px;
    font-weight: 700;
    letter-spacing: 1px;
    color: var(--text);
  }
  .logo-name span { color: var(--accent); }

  .header-right { display: flex; align-items: center; gap: 14px; }
  #connStatus { font-size: 11px; color: var(--muted); display: flex; align-items: center; gap: 6px; font-family: 'Space Mono', monospace; }
  #connDot { width: 7px; height: 7px; border-radius: 50%; background: #475569; display: inline-block; transition: background 0.3s; }

  .btn-primary {
    background: var(--accent);
    border: none; border-radius: 9px;
    padding: 10px 20px;
    color: #000;
    font-family: 'DM Sans', sans-serif;
    font-weight: 700; font-size: 13px;
    cursor: pointer;
    letter-spacing: 0.3px;
    transition: all 0.2s;
    box-shadow: 0 0 15px rgba(0,212,255,0.25);
  }
  .btn-primary:hover { background: #33DDFF; box-shadow: 0 0 25px rgba(0,212,255,0.5); transform: translateY(-1px); }

  /* ‚îÄ‚îÄ Main ‚îÄ‚îÄ */
  main { max-width: 1300px; margin: 0 auto; padding: 28px 32px; }

  /* ‚îÄ‚îÄ Stats ‚îÄ‚îÄ */
  .stats { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-bottom: 24px; }
  .stat-card {
    background: var(--surface);
    border-radius: 12px;
    padding: 16px;
    border: 1px solid var(--border);
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
    overflow: hidden;
  }
  .stat-card::before { content: ''; position: absolute; inset: 0; background: linear-gradient(135deg, transparent 60%, rgba(255,255,255,0.02)); }
  .stat-card:hover { border-color: var(--border2); transform: translateY(-2px); }
  .stat-card.active { border-color: currentColor; }
  .stat-icon { font-size: 20px; margin-bottom: 8px; }
  .stat-num { font-family: 'Space Mono', monospace; font-size: 28px; font-weight: 700; line-height: 1; }
  .stat-label { font-size: 10px; color: var(--muted); margin-top: 5px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.8px; }

  /* ‚îÄ‚îÄ Toolbar ‚îÄ‚îÄ */
  .toolbar { display: flex; gap: 10px; margin-bottom: 18px; }
  .search-input {
    flex: 1;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 11px 16px;
    color: var(--text);
    font-size: 13px;
    font-family: 'DM Sans', sans-serif;
    outline: none;
    transition: border-color 0.2s;
  }
  .search-input:focus { border-color: var(--accent); }
  .search-input::placeholder { color: var(--muted); }
  .filter-select {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 11px 14px;
    color: var(--text);
    font-size: 13px;
    font-family: 'DM Sans', sans-serif;
    outline: none;
    cursor: pointer;
  }

  /* ‚îÄ‚îÄ Table ‚îÄ‚îÄ */
  .table-wrap { background: var(--surface); border-radius: 14px; border: 1px solid var(--border); overflow-x: auto; }
  table { width: 100%; border-collapse: collapse; }
  thead tr { border-bottom: 1px solid var(--border); }
  th {
    padding: 12px 14px;
    text-align: left;
    font-size: 10px;
    font-weight: 700;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 1px;
    white-space: nowrap;
    font-family: 'Space Mono', monospace;
  }
  tbody tr { border-bottom: 1px solid rgba(31,45,69,0.6); transition: background 0.15s; }
  tbody tr:last-child { border-bottom: none; }
  tbody tr:hover { background: rgba(0,212,255,0.03); }
  td { padding: 12px 14px; font-size: 13px; vertical-align: middle; }
  .td-name { font-weight: 600; font-size: 13px; }
  .td-sub { font-size: 11px; color: var(--muted); margin-top: 2px; }
  .td-muted { color: var(--subtle); font-size: 12px; }
  .td-truncate { max-width: 160px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .td-equip { font-size: 11px; color: var(--accent); font-family: 'Space Mono', monospace; }

  /* ‚îÄ‚îÄ Status Select ‚îÄ‚îÄ */
  .status-sel {
    border: none;
    border-radius: 7px;
    padding: 5px 8px;
    font-size: 11px;
    font-weight: 700;
    cursor: pointer;
    font-family: 'DM Sans', sans-serif;
  }

  /* ‚îÄ‚îÄ Badge ‚îÄ‚îÄ */
  .badge { font-size: 11px; font-weight: 700; }
  .badge .ok { color: var(--green); }
  .badge .total { color: #475569; }

  /* ‚îÄ‚îÄ Urgency badge ‚îÄ‚îÄ */
  .urg-badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    border-radius: 6px;
    padding: 3px 8px;
    font-size: 11px;
    font-weight: 700;
    white-space: nowrap;
  }

  /* ‚îÄ‚îÄ Notes preview ‚îÄ‚îÄ */
  .notes-preview {
    max-width: 140px;
    font-size: 11px;
    color: var(--muted);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    font-style: italic;
  }

  /* ‚îÄ‚îÄ Actions ‚îÄ‚îÄ */
  .actions { display: flex; gap: 5px; }
  .act-btn {
    background: var(--border);
    border: none;
    border-radius: 7px;
    padding: 5px 9px;
    cursor: pointer;
    font-size: 12px;
    color: var(--subtle);
    transition: all 0.15s;
  }
  .act-btn.danger { color: var(--red); }
  .act-btn:hover { background: var(--border2); color: var(--text); }

  /* ‚îÄ‚îÄ Empty ‚îÄ‚îÄ */
  .empty { text-align: center; padding: 80px 20px; color: var(--muted); }
  .empty-icon { font-size: 40px; margin-bottom: 12px; }
  .empty-text { font-size: 16px; font-weight: 500; }
  .empty-sub { font-size: 13px; margin-top: 8px; color: var(--border2); }

  /* ‚îÄ‚îÄ Modal Overlay ‚îÄ‚îÄ */
  .overlay {
    position: fixed; inset: 0;
    background: rgba(0,0,0,0.8);
    display: flex; align-items: center; justify-content: center;
    z-index: 100;
    backdrop-filter: blur(6px);
  }
  .overlay.hidden { display: none; }
  .modal {
    background: var(--surface);
    border-radius: 18px;
    padding: 28px;
    width: 100%;
    max-width: 500px;
    border: 1px solid var(--border2);
    box-shadow: 0 25px 60px rgba(0,0,0,0.6), 0 0 0 1px rgba(0,212,255,0.05);
  }
  .modal-lg { max-width: 560px; max-height: 90vh; overflow-y: auto; }
  .modal-title {
    font-family: 'Space Mono', monospace;
    font-size: 16px;
    font-weight: 700;
    margin-bottom: 22px;
    letter-spacing: 0.5px;
  }
  .modal-subtitle { font-size: 12px; color: var(--muted); margin-top: 3px; }
  .modal-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; }
  .close-btn {
    background: var(--border);
    border: none;
    border-radius: 8px;
    width: 32px; height: 32px;
    color: var(--subtle);
    cursor: pointer;
    font-size: 16px;
    transition: all 0.15s;
  }
  .close-btn:hover { background: var(--border2); color: var(--text); }

  /* ‚îÄ‚îÄ Form ‚îÄ‚îÄ */
  .field { margin-bottom: 13px; }
  .field label {
    display: block;
    font-size: 10px;
    font-weight: 700;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.8px;
    margin-bottom: 5px;
    font-family: 'Space Mono', monospace;
  }
  .field input, .field textarea, .field select {
    width: 100%;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 9px;
    padding: 10px 13px;
    color: var(--text);
    font-size: 13px;
    font-family: 'DM Sans', sans-serif;
    outline: none;
    transition: border-color 0.2s;
  }
  .field input:focus, .field textarea:focus, .field select:focus { border-color: var(--accent); }
  .field input::placeholder, .field textarea::placeholder { color: var(--muted); }
  .field textarea { resize: vertical; }

  .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

  .status-btns { display: flex; flex-wrap: wrap; gap: 6px; }
  .status-opt {
    padding: 6px 11px;
    border-radius: 8px;
    border: 1.5px solid var(--border);
    background: transparent;
    color: var(--muted);
    font-weight: 600;
    font-size: 11px;
    cursor: pointer;
    font-family: 'DM Sans', sans-serif;
    transition: all 0.15s;
  }

  .urgencia-btns { display: flex; gap: 6px; }
  .urg-opt {
    flex: 1;
    padding: 7px 10px;
    border-radius: 8px;
    border: 1.5px solid var(--border);
    background: transparent;
    color: var(--muted);
    font-weight: 700;
    font-size: 12px;
    cursor: pointer;
    font-family: 'DM Sans', sans-serif;
    transition: all 0.15s;
    text-align: center;
  }

  .modal-footer { display: flex; gap: 10px; margin-top: 20px; }
  .btn-cancel {
    flex: 1;
    background: var(--border);
    border: none;
    border-radius: 9px;
    padding: 12px;
    color: var(--subtle);
    font-weight: 600;
    font-size: 13px;
    cursor: pointer;
    font-family: 'DM Sans', sans-serif;
    transition: background 0.2s;
  }
  .btn-cancel:hover { background: var(--border2); }
  .btn-save {
    flex: 2;
    background: var(--accent);
    border: none;
    border-radius: 9px;
    padding: 12px;
    color: #000;
    font-weight: 700;
    font-size: 13px;
    cursor: pointer;
    font-family: 'DM Sans', sans-serif;
    transition: all 0.2s;
    box-shadow: 0 0 15px rgba(0,212,255,0.2);
  }
  .btn-save:hover { background: #33DDFF; }
  .btn-save:disabled { background: var(--border); color: var(--muted); cursor: not-allowed; box-shadow: none; }

  /* ‚îÄ‚îÄ Detail Modal ‚îÄ‚îÄ */
  .section-title {
    display: flex;
    align-items: center;
    gap: 8px;
    font-family: 'Space Mono', monospace;
    font-weight: 700;
    font-size: 13px;
    margin-bottom: 12px;
    color: var(--subtle);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  .count-badge {
    background: var(--border);
    border-radius: 20px;
    padding: 1px 8px;
    font-size: 11px;
    color: var(--subtle);
    font-weight: 700;
  }

  .notes-block {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 14px;
    font-size: 13px;
    color: var(--subtle);
    line-height: 1.6;
    min-height: 60px;
    font-style: italic;
  }
  .notes-block.empty-note { color: var(--border2); }

  .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 16px; }
  .info-item { background: var(--bg); border-radius: 9px; padding: 12px 14px; border: 1px solid var(--border); }
  .info-item-label { font-size: 10px; font-weight: 700; color: var(--muted); text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 4px; font-family: 'Space Mono', monospace; }
  .info-item-val { font-size: 13px; font-weight: 600; }

  .item-row {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 13px;
    background: var(--bg);
    border-radius: 9px;
    margin-bottom: 7px;
    border: 1px solid var(--border);
  }
  .item-num { font-weight: 700; font-size: 13px; flex: 1; font-family: 'Space Mono', monospace; }
  .item-date { font-size: 11px; color: var(--muted); margin-left: 8px; font-weight: 400; font-family: 'DM Sans', sans-serif; }
  .toggle-btn {
    border: none;
    border-radius: 7px;
    padding: 4px 11px;
    font-size: 11px;
    font-weight: 700;
    cursor: pointer;
    font-family: 'DM Sans', sans-serif;
  }
  .del-btn { background: transparent; border: none; color: var(--red); cursor: pointer; font-size: 14px; padding: 2px 4px; opacity: 0.6; transition: opacity 0.15s; }
  .del-btn:hover { opacity: 1; }
  .add-row { display: flex; gap: 8px; margin-top: 8px; }
  .add-row input, .add-row select {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 8px 12px;
    color: var(--text);
    font-size: 13px;
    font-family: 'DM Sans', sans-serif;
    outline: none;
  }
  .add-row input { flex: 1; }
  .add-row input:focus { border-color: var(--accent); }
  .add-btn {
    background: var(--accent);
    border: none;
    border-radius: 8px;
    padding: 8px 15px;
    color: #000;
    font-weight: 700;
    font-size: 18px;
    cursor: pointer;
    line-height: 1;
    transition: all 0.2s;
  }
  .add-btn:hover { background: #33DDFF; }
  .divider { border: none; border-top: 1px solid var(--border); margin: 18px 0; }

  /* ‚îÄ‚îÄ Scrollbar ‚îÄ‚îÄ */
  ::-webkit-scrollbar { width: 6px; height: 6px; }
  ::-webkit-scrollbar-track { background: var(--bg); }
  ::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 3px; }
</style>
</head>
<body>

<header>
  <div class="header-inner">
    <div class="logo">
      <div class="logo-icon">üîß</div>
      <span class="logo-name">MANUTEN√á√ÉO<span>CRM</span></span>
    </div>
    <div class="header-right">
      <span id="connStatus">
        <span id="connDot"></span>
        <span id="connLabel">Conectando...</span>
      </span>
      <button class="btn-primary" onclick="openNewForm()">+ Novo Atendimento</button>
    </div>
  </div>
</header>

<main>
  <div class="stats" id="stats"></div>

  <div class="toolbar">
    <input class="search-input" id="searchInput" placeholder="üîç  Buscar por cliente, equipamento, empresa ou assunto..." oninput="render()" />
    <select class="filter-select" id="filterUrgencia" onchange="render()">
      <option value="todos">Todas urg√™ncias</option>
      <option value="alta">üî¥ Alta</option>
      <option value="media">üü° M√©dia</option>
      <option value="baixa">üü¢ Baixa</option>
    </select>
    <select class="filter-select" id="filterStatus" onchange="render()">
      <option value="todos">Todos status</option>
      <option value="solicitacao">üì• Solicita√ß√£o</option>
      <option value="em_andamento">üîß Em andamento</option>
      <option value="em_orcamento">üìã Em or√ßamento</option>
      <option value="pedido_peca">üì¶ Pedido de pe√ßa</option>
      <option value="concluido">‚úÖ Conclu√≠do</option>
    </select>
  </div>

  <div id="tableArea"></div>
</main>

<!-- Form Modal -->
<div class="overlay hidden" id="formOverlay" onclick="if(event.target===this)closeForm()">
  <div class="modal">
    <div class="modal-title" id="formTitle">Novo Atendimento</div>

    <div class="form-row">
      <div class="field"><label>Nome do cliente *</label><input id="fNome" placeholder="Ex: Jo√£o Silva" /></div>
      <div class="field"><label>Telefone</label><input id="fTel" placeholder="(11) 99999-9999" /></div>
    </div>
    <div class="form-row">
      <div class="field"><label>Empresa</label><input id="fEmp" placeholder="Ex: Empresa XYZ" /></div>
      <div class="field"><label>Equipamento / M√°quina</label><input id="fEquip" placeholder="Ex: Torno CNC #03" /></div>
    </div>
    <div class="field"><label>Assunto / Problema *</label><textarea id="fAssunto" rows="2" placeholder="Descreva o problema ou motivo do atendimento"></textarea></div>
    <div class="field"><label>Observa√ß√µes</label><textarea id="fNotes" rows="2" placeholder="Informa√ß√µes adicionais, hist√≥rico, detalhes t√©cnicos..."></textarea></div>
    <div class="field"><label>üîó Link de anexo</label><input id="fAnexo" placeholder="Cole aqui o link do Google Drive, foto do WhatsApp, etc." /></div>

    <div class="field">
      <label>Urg√™ncia</label>
      <div class="urgencia-btns" id="urgenciaBtns"></div>
    </div>
    <div class="field">
      <label>Status</label>
      <div class="status-btns" id="statusBtns"></div>
    </div>
    <div class="modal-footer">
      <button class="btn-cancel" onclick="closeForm()">Cancelar</button>
      <button class="btn-save" id="btnSave" onclick="saveForm()">Criar atendimento</button>
    </div>
  </div>
</div>

<!-- Detail Modal -->
<div class="overlay hidden" id="detailOverlay" onclick="if(event.target===this)closeDetail()">
  <div class="modal modal-lg">
    <div class="modal-header">
      <div>
        <div class="modal-title" id="detailName" style="margin-bottom:2px"></div>
        <div class="modal-subtitle" id="detailSub"></div>
      </div>
      <button class="close-btn" onclick="closeDetail()">‚úï</button>
    </div>

    <div class="info-grid" id="detailInfoGrid"></div>

    <div class="section-title">üìù Observa√ß√µes</div>
    <div class="notes-block" id="detailNotes"></div>

    <div style="margin-top:14px">
      <div class="section-title">üîó Anexo</div>
      <div id="detailAnexo"></div>
    </div>

    <hr class="divider">

    <div class="section-title">üìã Or√ßamentos <span class="count-badge" id="orcCount"></span></div>
    <div id="orcList"></div>
    <div class="add-row">
      <input id="newOrcNum" placeholder="N¬∫ do or√ßamento" onkeydown="if(event.key==='Enter')addOrc()" />
      <select id="newOrcStatus">
        <option value="aguardando">Aguardando</option>
        <option value="aprovado">Aprovado</option>
      </select>
      <button class="add-btn" onclick="addOrc()">+</button>
    </div>

    <hr class="divider">

    <div class="section-title">üì¶ Pedidos de Pe√ßa <span class="count-badge" id="pecaCount"></span></div>
    <div id="pecaList"></div>
    <div class="add-row">
      <input id="newPecaNum" placeholder="N¬∫ do pedido" onkeydown="if(event.key==='Enter')addPeca()" />
      <select id="newPecaStatus">
        <option value="solicitado">Solicitado</option>
        <option value="recebido">Recebido</option>
      </select>
      <button class="add-btn" onclick="addPeca()">+</button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getDatabase, ref, onValue, set, remove } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDLBsNggOcu-lbzSdy8VSmQczPIeU8Aw-I",
  authDomain: "crm-atendimento-b733d.firebaseapp.com",
  databaseURL: "https://crm-atendimento-b733d-default-rtdb.firebaseio.com",
  projectId: "crm-atendimento-b733d",
  storageBucket: "crm-atendimento-b733d.firebasestorage.app",
  messagingSenderId: "810578410723",
  appId: "1:810578410723:web:64c216b1b0714d939e19d6"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const ticketsRef = ref(db, 'tickets');

const STATUS = {
  solicitacao:  { label: 'Solicita√ß√£o',    color: '#F5A623', bg: 'rgba(245,166,35,0.15)',    icon: 'üì•' },
  em_andamento: { label: 'Em andamento',   color: '#3B8BF6', bg: 'rgba(59,139,246,0.15)',   icon: 'üîß' },
  em_orcamento: { label: 'Em or√ßamento',   color: '#9B6CF6', bg: 'rgba(155,108,246,0.15)',  icon: 'üìã' },
  pedido_peca:  { label: 'Pedido de pe√ßa', color: '#F97316', bg: 'rgba(249,115,22,0.15)',   icon: 'üì¶' },
  concluido:    { label: 'Conclu√≠do',      color: '#00C896', bg: 'rgba(0,200,150,0.15)',    icon: '‚úÖ' },
};
const URGENCIA = {
  baixa: { label: 'Baixa', color: '#00C896', bg: 'rgba(0,200,150,0.15)', dot: 'üü¢' },
  media: { label: 'M√©dia', color: '#F5A623', bg: 'rgba(245,166,35,0.15)', dot: 'üü°' },
  alta:  { label: 'Alta',  color: '#FF4D6D', bg: 'rgba(255,77,109,0.15)', dot: 'üî¥' },
};
const ORC_STATUS  = {
  aguardando: { label: 'Aguardando', color: '#F5A623', bg: 'rgba(245,166,35,0.2)' },
  aprovado:   { label: 'Aprovado',   color: '#00C896', bg: 'rgba(0,200,150,0.2)' }
};
const PECA_STATUS = {
  solicitado: { label: 'Solicitado', color: '#F97316', bg: 'rgba(249,115,22,0.2)' },
  recebido:   { label: 'Recebido',   color: '#00C896', bg: 'rgba(0,200,150,0.2)' }
};

let tickets = [];
let editingId = null;
let detailId = null;
let currentStatus = 'solicitacao';
let currentUrgencia = 'media';

// ‚îÄ‚îÄ Firebase sync ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
onValue(ticketsRef, (snapshot) => {
  const data = snapshot.val();
  tickets = data ? Object.values(data).map(t => ({
    urgencia: 'media', equipamento: '', observacoes: '',
    ...t,
    status: t.status === 'aguardando' ? 'solicitacao' : t.status
  })) : [];
  tickets.sort((a, b) => new Date(b.criadoEm) - new Date(a.criadoEm));
  document.getElementById('connDot').style.background = '#00C896';
  document.getElementById('connDot').style.boxShadow = '0 0 8px #00C896';
  document.getElementById('connLabel').textContent = 'Ao vivo ‚úì';
  render();
  if (detailId) renderDetail();
});

function sanitize(obj) {
  const clean = {};
  for (const [k, v] of Object.entries(obj)) {
    if (v === undefined || v === null) { clean[k] = ''; }
    else if (Array.isArray(v)) { clean[k] = v.map(i => sanitize(i)); }
    else if (typeof v === 'object') { clean[k] = sanitize(v); }
    else { clean[k] = v; }
  }
  return clean;
}
function saveOne(ticket) { set(ref(db, 'tickets/' + ticket.id), sanitize(ticket)); }
function removeOne(id) { remove(ref(db, 'tickets/' + id)); }
function genId() { return Date.now().toString(36) + Math.random().toString(36).substr(2); }
function fmt(iso) {
  if (!iso) return '‚Äî';
  const d = new Date(iso);
  return d.toLocaleDateString('pt-BR') + ' ' + d.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
}
function fmtDate(iso) {
  if (!iso) return '‚Äî';
  return new Date(iso).toLocaleDateString('pt-BR');
}

// ‚îÄ‚îÄ Render ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function render() { renderStats(); renderTable(); }

function renderStats() {
  const el = document.getElementById('stats');
  const fs = document.getElementById('filterStatus').value;
  el.innerHTML = Object.entries(STATUS).map(([k, v]) => {
    const cnt = tickets.filter(t => t.status === k).length;
    const active = fs === k ? `border-color:${v.color};` : '';
    return `<div class="stat-card" style="${active}color:${v.color}" onclick="toggleFilter('${k}')">
      <div class="stat-icon">${v.icon}</div>
      <div class="stat-num" style="color:${v.color}">${cnt}</div>
      <div class="stat-label">${v.label}</div>
    </div>`;
  }).join('');
}

function toggleFilter(key) {
  const sel = document.getElementById('filterStatus');
  sel.value = sel.value === key ? 'todos' : key;
  render();
}

function renderTable() {
  const q = document.getElementById('searchInput').value.toLowerCase();
  const fs = document.getElementById('filterStatus').value;
  const fu = document.getElementById('filterUrgencia').value;

  const filtered = tickets.filter(t => {
    const match = t.nome.toLowerCase().includes(q)
      || (t.empresa||'').toLowerCase().includes(q)
      || t.assunto.toLowerCase().includes(q)
      || (t.equipamento||'').toLowerCase().includes(q);
    const statusOk = fs === 'todos' || t.status === fs;
    const urgOk = fu === 'todos' || t.urgencia === fu;
    return match && statusOk && urgOk;
  });

  const urgOrder = { alta: 0, media: 1, baixa: 2 };
  filtered.sort((a, b) => urgOrder[a.urgencia||'media'] - urgOrder[b.urgencia||'media']);

  const area = document.getElementById('tableArea');
  if (!filtered.length) {
    area.innerHTML = `<div class="empty">
      <div class="empty-icon">üîß</div>
      <div class="empty-text">${tickets.length === 0 ? 'Nenhum atendimento ainda.' : 'Nenhum resultado encontrado.'}</div>
      ${tickets.length === 0 ? '<div class="empty-sub">Clique em "+ Novo Atendimento" para come√ßar.</div>' : ''}
    </div>`;
    return;
  }

  const rows = filtered.map(t => {
    const st = STATUS[t.status];
    const urg = URGENCIA[t.urgencia || 'media'];
    const orcCount = (t.orcamentos||[]).length;
    const pecaCount = (t.pecas||[]).length;
    const orcAprov = (t.orcamentos||[]).filter(o => o.status === 'aprovado').length;
    const pecaReceb = (t.pecas||[]).filter(p => p.status === 'recebido').length;
    const orcBadge = orcCount ? `<span class="ok">${orcAprov}‚úì</span> <span class="total">/ ${orcCount}</span>` : '<span style="color:#2a3d5a">‚Äî</span>';
    const pecaBadge = pecaCount ? `<span class="ok">${pecaReceb}‚úì</span> <span class="total">/ ${pecaCount}</span>` : '<span style="color:#2a3d5a">‚Äî</span>';
    const opts = Object.entries(STATUS).map(([k,v]) => `<option value="${k}" ${t.status===k?'selected':''}>${v.label}</option>`).join('');
    const notesHtml = t.observacoes ? `<div class="notes-preview" title="${esc(t.observacoes)}">${esc(t.observacoes)}</div>` : '<span style="color:#2a3d5a;font-size:11px">‚Äî</span>';

    return `<tr>
      <td>
        <div class="td-name">${esc(t.nome)}</div>
        ${t.telefone?`<div class="td-sub">${esc(t.telefone)}</div>`:''}
        ${t.empresa?`<div class="td-sub">${esc(t.empresa)}</div>`:''}
      </td>
      <td><div class="td-equip">${esc(t.equipamento||'‚Äî')}</div></td>
      <td><div class="td-truncate" title="${esc(t.assunto)}">${esc(t.assunto)}</div></td>
      <td>${notesHtml}</td>
      <td><span class="urg-badge" style="background:${urg.bg};color:${urg.color}">${urg.dot} ${urg.label}</span></td>
      <td><select class="status-sel" style="background:${st.bg};color:${st.color}" onchange="changeStatus('${t.id}',this.value)">${opts}</select></td>
      <td><span class="badge">${orcBadge}</span></td>
      <td><span class="badge">${pecaBadge}</span></td>
      <td style="font-size:11px;color:var(--muted);white-space:nowrap;font-family:'Space Mono',monospace">${fmtDate(t.criadoEm)}</td>
      <td style="font-size:11px;color:${t.concluidoEm?'#00C896':'#2a3d5a'};white-space:nowrap;font-family:'Space Mono',monospace">${fmtDate(t.concluidoEm)}</td>
      <td><div class="actions">
        <button class="act-btn" onclick="openDetail('${t.id}')" title="Ver detalhes">üìã</button>
        <button class="act-btn" onclick="openEdit('${t.id}')" title="Editar">‚úèÔ∏è</button>
        <button class="act-btn danger" onclick="delTicket('${t.id}')" title="Excluir">üóëÔ∏è</button>
      </div></td>
    </tr>`;
  }).join('');

  area.innerHTML = `<div class="table-wrap"><table>
    <thead><tr>
      <th>Cliente</th><th>Equipamento</th><th>Assunto</th><th>Obs.</th><th>Urg√™ncia</th><th>Status</th>
      <th>Or√ß.</th><th>Pe√ßas</th><th>Criado</th><th>Conclu√≠do</th><th>A√ß√µes</th>
    </tr></thead>
    <tbody>${rows}</tbody>
  </table></div>`;
}

function esc(s) { return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

function changeStatus(id, val) {
  const t = tickets.find(x => x.id === id);
  if (!t) return;
  saveOne({
    ...t,
    status: val,
    inicioEm: val === 'em_andamento' && !t.inicioEm ? new Date().toISOString() : t.inicioEm,
    concluidoEm: val === 'concluido' && !t.concluidoEm ? new Date().toISOString() : (val !== 'concluido' ? null : t.concluidoEm),
  });
}

function delTicket(id) {
  if (!confirm('Remover este atendimento?')) return;
  removeOne(id);
}

// ‚îÄ‚îÄ Urg√™ncia ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildUrgenciaBtns(selected) {
  document.getElementById('urgenciaBtns').innerHTML = Object.entries(URGENCIA).map(([k, v]) => {
    const active = selected === k;
    const style = active ? `border-color:${v.color};background:${v.bg};color:${v.color}` : '';
    return `<button class="urg-opt" style="${style}" onclick="selectUrgencia('${k}')">${v.dot} ${v.label}</button>`;
  }).join('');
  currentUrgencia = selected;
}
function selectUrgencia(key) { currentUrgencia = key; buildUrgenciaBtns(key); }

// ‚îÄ‚îÄ Status buttons ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildStatusBtns(selected) {
  document.getElementById('statusBtns').innerHTML = Object.entries(STATUS).map(([k, v]) => {
    const active = selected === k;
    const style = active ? `border-color:${v.color};background:${v.bg};color:${v.color}` : '';
    return `<button class="status-opt" style="${style}" onclick="selectStatus('${k}')">${v.icon} ${v.label}</button>`;
  }).join('');
  currentStatus = selected;
}
function selectStatus(key) { currentStatus = key; buildStatusBtns(key); }

// ‚îÄ‚îÄ Form Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openNewForm() {
  editingId = null;
  document.getElementById('formTitle').textContent = 'Novo Atendimento';
  document.getElementById('btnSave').textContent = 'Criar atendimento';
  document.getElementById('fNome').value = '';
  document.getElementById('fTel').value = '';
  document.getElementById('fEmp').value = '';
  document.getElementById('fEquip').value = '';
  document.getElementById('fAssunto').value = '';
  document.getElementById('fNotes').value = '';
  document.getElementById('fAnexo').value = '';
  buildStatusBtns('solicitacao');
  buildUrgenciaBtns('media');
  document.getElementById('formOverlay').classList.remove('hidden');
  setTimeout(() => document.getElementById('fNome').focus(), 100);
}

function openEdit(id) {
  const t = tickets.find(x => x.id === id);
  if (!t) return;
  editingId = id;
  document.getElementById('formTitle').textContent = 'Editar Atendimento';
  document.getElementById('btnSave').textContent = 'Salvar altera√ß√µes';
  document.getElementById('fNome').value = t.nome;
  document.getElementById('fTel').value = t.telefone || '';
  document.getElementById('fEmp').value = t.empresa || '';
  document.getElementById('fEquip').value = t.equipamento || '';
  document.getElementById('fAssunto').value = t.assunto;
  document.getElementById('fNotes').value = t.observacoes || '';
  document.getElementById('fAnexo').value = t.anexo || '';
  buildStatusBtns(t.status);
  buildUrgenciaBtns(t.urgencia || 'media');
  document.getElementById('formOverlay').classList.remove('hidden');
}

function closeForm() { document.getElementById('formOverlay').classList.add('hidden'); }

function saveForm() {
  const nome = document.getElementById('fNome').value.trim();
  const assunto = document.getElementById('fAssunto').value.trim();
  if (!nome || !assunto) { alert('Nome e assunto s√£o obrigat√≥rios.'); return; }
  const tel = document.getElementById('fTel').value.trim();
  const emp = document.getElementById('fEmp').value.trim();
  const equip = document.getElementById('fEquip').value.trim();
  const notes = document.getElementById('fNotes').value.trim();
  const anexo = document.getElementById('fAnexo').value.trim();

  if (editingId) {
    const t = tickets.find(x => x.id === editingId);
    if (t) {
      const inicioEm = currentStatus === 'em_andamento' && !t.inicioEm ? new Date().toISOString() : t.inicioEm;
      const concluidoEm = currentStatus === 'concluido' && t.status !== 'concluido' ? new Date().toISOString() : (currentStatus !== 'concluido' ? null : t.concluidoEm);
      saveOne({ ...t, nome, telefone: tel, empresa: emp, equipamento: equip, assunto, observacoes: notes, anexo, status: currentStatus, urgencia: currentUrgencia, inicioEm, concluidoEm });
    }
  } else {
    saveOne({
      id: genId(), nome, telefone: tel, empresa: emp, equipamento: equip,
      assunto, observacoes: notes, anexo, status: currentStatus, urgencia: currentUrgencia,
      criadoEm: new Date().toISOString(),
      inicioEm: currentStatus === 'em_andamento' ? new Date().toISOString() : null,
      concluidoEm: null,
      orcamentos: [], pecas: []
    });
  }
  closeForm();
}

// ‚îÄ‚îÄ Detail Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openDetail(id) { detailId = id; renderDetail(); document.getElementById('detailOverlay').classList.remove('hidden'); }
function closeDetail() { document.getElementById('detailOverlay').classList.add('hidden'); detailId = null; }

function renderDetail() {
  const t = tickets.find(x => x.id === detailId);
  if (!t) return;
  const st = STATUS[t.status];
  const urg = URGENCIA[t.urgencia || 'media'];

  document.getElementById('detailName').textContent = t.nome;
  document.getElementById('detailSub').textContent = [t.empresa, t.assunto].filter(Boolean).join(' ¬∑ ');

  document.getElementById('detailInfoGrid').innerHTML = [
    { label: 'Equipamento', val: t.equipamento || '‚Äî' },
    { label: 'Urg√™ncia', val: `<span style="color:${urg.color}">${urg.dot} ${urg.label}</span>` },
    { label: 'Status', val: `<span style="color:${st.color}">${st.icon} ${st.label}</span>` },
    { label: 'Criado em', val: fmt(t.criadoEm) },
    { label: 'In√≠cio', val: fmt(t.inicioEm) },
    { label: 'Conclus√£o', val: fmt(t.concluidoEm) },
  ].map(i => `<div class="info-item"><div class="info-item-label">${i.label}</div><div class="info-item-val">${i.val}</div></div>`).join('');

  const anexoEl = document.getElementById('detailAnexo');
  if (t.anexo) {
    anexoEl.innerHTML = `<a href="${esc(t.anexo)}" target="_blank" rel="noopener" style="display:inline-flex;align-items:center;gap:8px;background:var(--bg);border:1px solid var(--border);border-radius:9px;padding:10px 14px;color:var(--accent);font-size:13px;text-decoration:none;word-break:break-all;transition:border-color 0.2s" onmouseover="this.style.borderColor='var(--accent)'" onmouseout="this.style.borderColor='var(--border)'">üîó <span style="text-decoration:underline">${esc(t.anexo)}</span></a>`;
  } else {
    anexoEl.innerHTML = `<div style="color:#2a3d5a;font-size:12px;padding:4px 0">Nenhum anexo registrado.</div>`;
  }

  const notesEl = document.getElementById('detailNotes');
  if (t.observacoes) {
    notesEl.textContent = t.observacoes;
    notesEl.classList.remove('empty-note');
  } else {
    notesEl.textContent = 'Nenhuma observa√ß√£o registrada.';
    notesEl.classList.add('empty-note');
  }

  const orcs = t.orcamentos || [];
  const pecas = t.pecas || [];
  document.getElementById('orcCount').textContent = orcs.length || '';
  document.getElementById('pecaCount').textContent = pecas.length || '';

  document.getElementById('orcList').innerHTML = orcs.map(o => {
    const st = ORC_STATUS[o.status];
    return `<div class="item-row">
      <div class="item-num">#${esc(o.numero)}<span class="item-date">${fmt(o.criadoEm)}</span></div>
      <button class="toggle-btn" style="background:${st.bg};color:${st.color}" onclick="toggleOrc('${o.id}')">${st.label}</button>
      <button class="del-btn" onclick="delOrc('${o.id}')">üóëÔ∏è</button>
    </div>`;
  }).join('') || '<div style="color:#2a3d5a;font-size:12px;padding:8px 0">Nenhum or√ßamento registrado.</div>';

  document.getElementById('pecaList').innerHTML = pecas.map(p => {
    const st = PECA_STATUS[p.status];
    return `<div class="item-row">
      <div class="item-num">#${esc(p.numero)}<span class="item-date">${fmt(p.criadoEm)}</span></div>
      <button class="toggle-btn" style="background:${st.bg};color:${st.color}" onclick="togglePeca('${p.id}')">${st.label}</button>
      <button class="del-btn" onclick="delPeca('${p.id}')">üóëÔ∏è</button>
    </div>`;
  }).join('') || '<div style="color:#2a3d5a;font-size:12px;padding:8px 0">Nenhum pedido registrado.</div>';
}

function getTicket() { return tickets.find(t => t.id === detailId); }
function updateTicket(t) { saveOne(t); }

function addOrc() {
  const num = document.getElementById('newOrcNum').value.trim();
  if (!num) return;
  const t = { ...getTicket() };
  t.orcamentos = [...(t.orcamentos||[]), { id: genId(), numero: num, status: document.getElementById('newOrcStatus').value, criadoEm: new Date().toISOString() }];
  updateTicket(t);
  document.getElementById('newOrcNum').value = '';
}
function delOrc(id) { const t = {...getTicket()}; t.orcamentos = t.orcamentos.filter(o => o.id !== id); updateTicket(t); }
function toggleOrc(id) { const t = {...getTicket()}; t.orcamentos = t.orcamentos.map(o => o.id === id ? {...o, status: o.status === 'aprovado' ? 'aguardando' : 'aprovado'} : o); updateTicket(t); }

function addPeca() {
  const num = document.getElementById('newPecaNum').value.trim();
  if (!num) return;
  const t = { ...getTicket() };
  t.pecas = [...(t.pecas||[]), { id: genId(), numero: num, status: document.getElementById('newPecaStatus').value, criadoEm: new Date().toISOString() }];
  updateTicket(t);
  document.getElementById('newPecaNum').value = '';
}
function delPeca(id) { const t = {...getTicket()}; t.pecas = t.pecas.filter(p => p.id !== id); updateTicket(t); }
function togglePeca(id) { const t = {...getTicket()}; t.pecas = t.pecas.map(p => p.id === id ? {...p, status: p.status === 'recebido' ? 'solicitado' : 'recebido'} : p); updateTicket(t); }

// expose to global
Object.assign(window, {
  openNewForm, openEdit, closeForm, saveForm,
  openDetail, closeDetail,
  selectStatus, selectUrgencia,
  changeStatus, delTicket,
  addOrc, delOrc, toggleOrc,
  addPeca, delPeca, togglePeca,
  toggleFilter
});

render();
</script>
</body>
</html>
